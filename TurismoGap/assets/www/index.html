<!DOCTYPE html> 
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Turismo Digital</title>
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.css" />
<script src="http://code.jquery.com/jquery-1.6.4.min.js"></script> 
<script src="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.js"></script>

<script type="text/javascript" charset="utf-8" src="jquery-mobile/CalendarEventPlugin.js"></script>
</head> 
<body> 

<div data-role="page" id="page">
 <div data-role="header" data-theme="d">
 	<h1>Turismo Digital</h1>
 </div>
 	<div data-role="content"> 
 	<ul data-role="listview" data-split-icon="loading" data-theme="b">
 	 <li><a href="#prp" onClick="getEventos()"><span style="right:5px;background: url(img/eventos.png) no-repeat;padding:3px;padding-left:20px"></span>&nbsp;Eventos</a></li>
  <li><a href="#page3"><span style="right:5px;background: url(img/guia.png) no-repeat;padding:3px;padding-left:20px"></span>&nbsp;Guías</a></li>
 	 <li><a href="#page4"><span style="right:5px;background: url(img/itinerario.png) no-repeat;padding:3px;padding-left:20px"></span>&nbsp;Itinerario</a></li>
     	 <li><a href="#page4"><span style="right:5px;background: url(img/visita.png) no-repeat;padding:3px;padding-left:20px"></span>&nbsp;Visitas virtuales</a></li>
 	 </ul>	 
 </div>
 <div data-role="footer" data-theme="c">
 	<h4>Pasea con la ayuda de las nuevas tecnologías</h4>
 </div>
</div>

<div data-role="page" id="guias">
 <div data-role="header">
 	<h1>Página dos</h1>
 </div>
 	<div data-role="content"> 
 	 Contenido	 
 </div>
 <div data-role="footer">
 	<h4>Pie de página</h4>
 </div>
</div>

<div data-role="page" id="page3">
 <div data-role="header">
 	<h1>Página tres</h1>
 </div>
 	<div data-role="content"> 
 	 Contenido	 
 </div>
 <div data-role="footer">
 	<h4>Pie de página</h4>
 </div>
</div>

<div data-role="page" id="page4">
 <div data-role="header">
 	<h1>Página cuatro</h1>
 </div>
 	<div data-role="content"> 
 	 Contenido	 
 </div>
 <div data-role="footer">
 	<h4>Pie de página</h4>
 </div>
</div>

<div data-role="page" id="prp">
 <div data-role="header" data-theme="b">
<h1>Listado de Eventos</h1>
 </div>
<div id="content" data-role="content">
<ul id="listview" data-role="listview" data-inset="true" data-theme="c" data-dividertheme="b">
</ul>
</div>
<div id="dialogTest" data-role="page">
    <div data-role="header" data-position="fixed">
        <h1>test</h1>
    </div>
    <div data-role="content">
        I am a dialog :)
    </div>
    <div data-role="footer" data-position="fixed">
        <h4>test</h4>
    </div>
</div>
</div>  

</body>
<script type="text/javascript">
function onDeviceReady() {}
document.addEventListener("deviceready", onDeviceReady, false);

function getEventos(){
$.ajax({
type: "POST",
contentType: "application/json; charset=utf-8",
dataType: "json",
  url: "http://192.168.1.130:8080/WSTurismoDigital/rest/turismoDigital/GetEventos",
  data: '{}',
  success: function(msg) {	
  var listview;
  var parent = document.getElementById('listview');	
	$.each(msg, function (i, theItem) {
		var startDateString = theItem.startDate.toString();
		var endDateString = theItem.endDate.toString();
		var location = theItem.location.toString();
        var title = encodeURIComponent(theItem.title.toString());
		
        var listdiv = document.createElement('li');
        listdiv.setAttribute('id','listdiv');
        listdiv.setAttribute('data-role','list-divider');
        listdiv.innerHTML = theItem.startDate.toString();	
			
		parent.appendChild(listdiv);
		
		var listItem = document.createElement('li');
        listItem.innerHTML = '<a data-index="' + i + '" onClick=viewDetails('+i+',"'+theItem.location.toString()+'") > <h2>'+theItem.title.toString()+'</h2><p><strong>'+theItem.location.toString()+'</strong></p><p>Descripci�n</p><p class="ui-li-aside"><a href="#" onClick=calendarCall("'+startDateString+'","'+endDateString+'","'+title+'","'+location+'") data-icon="plus" data-role="button" data-mini="true" data-theme="b">Añadir</a></p></a>';
		parent.appendChild(listItem);
	 });
  var list = document.getElementById('listview');
  $(list).listview("refresh");
  },
  error: function(msg) {
   if (msg.status == 200 && result.statusText == "OK") {
    //this is here only because chrome breaks on this method only for no reason whatsoever.
    //chrome sees the request as failed, but everything happens fine...
    success(msg);
  }
  else {
    alert("FAILED : " + msg.status + ' ' + msg.statusText);
  }
  }
});
}
function calendarCall(start,end,title,location){
	var notes="";
	var dateParts = start.split("/");
    var startDate = new Date(dateParts[2], (dateParts[1] - 1), dateParts[0]);
    dateParts = end.split("/");
    var endDate = new Date(dateParts[2], (dateParts[1] - 1), dateParts[0]);   
    var titleString=decodeURIComponent(title);
    
	var success = function() { alert("Evento a�adido correctamente"); };
	var error = function(message) { alert("Error:No se ha a�adido el evento"); };
	window.plugins.calendarPlugin.createEvent(titleString,location,notes,startDate,endDate, success, error);
}
function viewDetails(index,texto){
	    var  $toPage = $('#details_' + index);
		    //stop the browser from scrolling to the top of the page due to the hash mark (#) in the link's href attribute
    event.preventDefault();
    
    //check to see if the page for the link clicked already exists, if so then don't re-add it to the DOM
    if ($toPage.length === 0) {
        
        //no page was found so create one, we can access the photos object to insert data related to the link clicked
        $('body').append('<div data-role="page" id="details_' + index + '"><div data-role="content"><p>Some Key: ' + texto + '</p><a data-role="button" href="#home">Back Home</a></div></div>');
        
        //set the $toPage variable to the newly added page so jQuery Mobile can navigate to it
        $toPage = $('#details_' + index);
    }
    
    //change to the desired page
    $.mobile.changePage($toPage);
}
</script>
</html>
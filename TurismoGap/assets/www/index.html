<!DOCTYPE html> 
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Turismo Digital</title>
<link rel="stylesheet" href="jquery-mobile/jquery.mobile-1.0.min.css" />
<link type="text/css" href="http://dev.jtsage.com/cdn/datebox/latest/jqm-datebox.min.css" rel="stylesheet" /> 
<link href="default.css" rel="stylesheet">
<script src="http://code.jquery.com/jquery-1.6.4.min.js"></script> 
<script src="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.js"></script>
<script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.7/jquery.validate.min.js"></script>
<script type="text/javascript" charset="utf-8" src="jquery-mobile/CalendarEventPlugin.js"></script>
<script type="text/javascript" src="http://dev.jtsage.com/cdn/datebox/latest/jquery.mobile.datebox.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
</head> 
<body> 

<div data-role="page" id="page">
 <div data-role="header" data-theme="d">
 	<h1>Turismo Digital</h1>
 </div>
 	<div data-role="content"> 
 	<ul data-role="listview" data-split-icon="loading" data-theme="b">
     <li><a href="#tipoEvento" onClick="getTiposEventos()"><span style="right:5px;background: url(img/eventos.png) no-repeat;padding:3px;padding-left:20px"></span>&nbsp;Eventos</a></li>
  <li><a href="#tipoGuias" onClick="getTiposGuias()"><span style="right:5px;background: url(img/guia.png) no-repeat;padding:3px;padding-left:20px"></span>&nbsp;Guías</a></li>
     <li><a href="#tipoItinerarios" onClick="getTiposItinerarios()"><span style="right:5px;background: url(img/itinerario.png) no-repeat;padding:3px;padding-left:20px"></span>&nbsp;Itinerario</a></li>
         <li><a href="#page4"><span style="right:5px;background: url(img/visita.png) no-repeat;padding:3px;padding-left:20px"></span>&nbsp;Visitas virtuales</a></li>
 	 </ul>	 
 </div>
 <div data-role="footer" data-theme="b">
 	<h4 style="text-align:center;">Pasea con la ayuda de las nuevas tecnologías</h4>
 </div>
</div>
<div data-role="page" id="tipoEvento">
	<div data-role="header" data-theme="b">
		<h1>Lista Tipos Eventos</h1>
	</div>
	<div id="content" data-role="content"><form id="frmLogin" class="validate">
        <label><strong>Tipo de Evento:</strong></label>
		<select name="tiposEventoSelect" id="tiposEventoSelect" class="required">
            <!-- Add options here -->
        </select><br>
        <label><strong>Fecha Inicio:</strong></label>
        <input type="text" data-role="datebox" name="fechaInicio" id="fechaInicio" value="01-01-2000"  data-options='{"mode":"calbox", "useNewStyle":true,"dateFormat": "dd-mm-YYYY"}' class="required"><br>
        <label><strong>Fecha Fin:</strong></label>
        <input type="text" data-role="datebox" name="fechaFin" id="fechaFin" value="01-01-2020" data-options='{"mode":"calbox", "useNewStyle":true,"dateFormat": "dd-mm-YYYY"}' class="required"><br>
        <a href="#eventos" data-theme="b" data-role="button" onClick="getEventos()">Buscar</a>
        </form>
	</div>
    <div data-role="footer" data-id="foo1" data-position="fixed" data-theme="b">
		<div data-role="navbar">
		<ul>
			<li><a href="#page">Inicio</a></li>
			<li><a href="b.html">Guías</a></li>
			<li><a href="#tipoItinerarios" onClick="getTiposItinerarios()">Itinerario</a></li>
			<li><a href="d.html">Visitas</a></li>
		</ul>
		</div>
	</div>
</div>
<div data-role="page" id="eventos">
	<div data-role="header" data-theme="b">
		<h1>Listado de Eventos</h1>
	</div>
	<div id="content" data-role="content">
		<ul id="listview" data-role="listview" data-inset="true" data-theme="c" data-dividertheme="b">
	</ul>
	</div>
    <div data-role="footer" data-id="foo1" data-position="fixed" data-theme="b">
		<div data-role="navbar">
		<ul>
			<li><a href="#page">Inicio</a></li>
			<li><a href="b.html">Guías</a></li>
			<li><a href="#tipoItinerarios" onClick="getTiposItinerarios()">Itinerario</a></li>
			<li><a href="d.html">Visitas</a></li>
		</ul>
		</div>
	</div>
</div>

<div data-role="page" id="tipoItinerarios">
	<div data-role="header" data-theme="b">
		<h1>Lista Tipos Itinerarios</h1>
	</div>
	<div id="content" data-role="content"><form id="frmItinerarios" class="validate">
        <label><strong>Tipo de Itinerarios:</strong></label>
		<select name="tiposItinerariosSelect" id="tiposItinerariosSelect" class="required">
            <!-- Add options here -->
        </select><br>
        <a href="#itinerarios" data-role="button" data-theme="b" onClick="getItinerarios()">Buscar</a>
        </form>
	</div>
    <div data-role="footer" data-id="foo1" data-position="fixed" data-theme="b">
		<div data-role="navbar">
		<ul>
			<li><a href="#page">Inicio</a></li>
			<li><a href="#tipoEvento" onClick="getTiposEventos()">Eventos</a></li>
			<li><a href="c.html">Guías</a></li>
			<li><a href="d.html">Visitas</a></li>
		</ul>
		</div>
	</div>
</div>

<div data-role="page" id="itinerarios">
	<div data-role="header" data-theme="b">
		<h1>Listado de Itinerarios</h1>
	</div>
	<div id="content" data-role="content">
		<ul id="listviewItinerarios" data-role="listview" data-inset="true" data-theme="c" data-dividertheme="b">
	</ul>
	</div>
    <div data-role="footer" data-id="foo1" data-position="fixed" data-theme="b">
		<div data-role="navbar">
		<ul>
			<li><a href="#page">Inicio</a></li>
			<li><a href="#tipoEvento" onClick="getTiposEventos()">Eventos</a></li>
			<li><a href="c.html">Guías</a></li>
			<li><a href="d.html">Visitas</a></li>
		</ul>
		</div>
	</div>
</div>

<div data-role="page" id="tipoGuias">
	<div data-role="header" data-theme="b">
		<h1>Lista Tipos Guias</h1>
	</div>
	<div id="content" data-role="content"><form id="frmGuias" class="validate">
        <label><strong>Tipo de Guias:</strong></label>
		<select name="tiposGuiasSelect" id="tiposGuiasSelect" class="required">
            <!-- Add options here -->
        </select><br>
        <a href="#guias" data-role="button" data-theme="b" onClick="getGuias()">Buscar</a>
        </form>
	</div>
    <div data-role="footer" data-id="foo1" data-position="fixed" data-theme="b">
		<div data-role="navbar">
		<ul>
			<li><a href="#page">Inicio</a></li>
			<li><a href="#tipoEvento" onClick="getTiposEventos()">Eventos</a></li>
			<li><a href="#tipoItinerarios" onClick="getTiposItinerarios()">Itinerarios</a></li>
			<li><a href="d.html">Visitas</a></li>
		</ul>
		</div>
	</div>
</div>

<div data-role="page" id="guias">
	<div data-role="header" data-theme="b">
		<h1>Listado de Guias</h1>
	</div>
	<div id="content" data-role="content">
		<ul id="listviewGuias" data-role="listview" data-inset="true" data-theme="c" data-dividertheme="b">
	</ul>
	</div>
    <div data-role="footer" data-id="foo1" data-position="fixed" data-theme="b">
		<div data-role="navbar">
		<ul>
			<li><a href="#page">Inicio</a></li>
			<li><a href="#tipoEvento" onClick="getTiposEventos()">Eventos</a></li>
			<li><a href="#tipoItinerarios" onClick="getTiposItinerarios()">Itinerarios</a></li>
			<li><a href="d.html">Visitas</a></li>
		</ul>
		</div>
	</div>
</div>

<div data-role="page" id="page4">
 <div data-role="header">
 	<h1>Página cuatro</h1>
 </div>
 	<div data-role="content"> 
 	 Contenido	 
 </div>
 <div data-role="footer">
 	<h4>Pie de página</h4>
 </div>
</div>

</body>
<script type="text/javascript">

$( "#frmLogin" ).validate({
    submitHandler: function( form ) {
		var selec=$("#tiposEventoSelect").val();
		var fechaInicio=$("#fechaInicio").val();
		var fechaFin=$("#fechaFin").val();
		getEventos(selec,fechaInicio,fechaFin);
    }
});

$( "#frmItinerarios" ).validate({
    submitHandler: function( form ) {
		var selec=$("#tiposItinerariosSelect").val();
		getItinerarios(selec);
    }
});

function onDeviceReady() {}
document.addEventListener("deviceready", onDeviceReady, false);

function getTiposEventos(){
	$.ajax({
	type: "GET",
	contentType: "application/json; charset=utf-8",
	dataType: "json",
	/*url:"http://localhost:8080/WSTurismoDigital/rest/turismoDigital/getTipoEventos?idioma=es",*/
	url:"http://85.251.45.123:65234/GISWeb/rest/eventos/getTipoEventos?idioma=es",
	data: '{}',
	success: function(msg) {	
		$.each(msg, function (i, theItem) {
			$('#tiposEventoSelect').append('<option value='+parseInt(theItem.id)+'>'+theItem.nombre.toString()	+'</option>');
	});
	$('#tiposEventoSelect').listview("refresh");
  	},
  	error: function(msg) {
    	alert("FAILED : " + msg.status + ' ' + msg.statusText);
  }
});
}
function getEventos(){
tipoEvento=$("#tiposEventoSelect").val();
fechaInicio=$("#fechaInicio").val();
fechaFin=$("#fechaFin").val();
$.ajax({
type: "GET",
contentType: "application/json; charset=utf-8",
dataType: "json",
 /* url: "http://localhost:8080/WSTurismoDigital/rest/turismoDigital/getEventos?idioma=es",*/
   url: "http://85.251.45.123:65234/GISWeb/rest/eventos/getEventos?idioma=es&tipo="+tipoEvento+"&fechaInicio="+fechaInicio+"&fechaFin="+fechaFin,
  data: '{}',
  success: function(msg) {	
  var listview;
  var parent = document.getElementById('listview');	
  $('#listview').empty();
	$.each(msg, function (i, theItem) {


		var startDateString = theItem.fechaInicio.toString();
		var endDateString = theItem.fechaFin.toString();
		var location = theItem.localizacion.toString();
        var nombre = encodeURIComponent(theItem.nombre.toString());
		var descripcion = encodeURIComponent(theItem.descripcion.toString());
		var horario = encodeURIComponent(theItem.horarios.toString());
		var precio = encodeURIComponent(theItem.precios.toString());
		var infoExtra = encodeURIComponent(theItem.infoExtra.toString());
		var coordenadas = theItem.puntoInteresCoordenadas.toString().split(',');
		coordenadasX = coordenadas[0];
		coordenadasY = coordenadas[1];

        var listdiv = document.createElement('li');
        listdiv.setAttribute('id','listdiv');
        listdiv.setAttribute('data-role','list-divider');
        listdiv.innerHTML = startDateString;	
		parent.appendChild(listdiv);
		var listItem = document.createElement('li');
		listItem.setAttribute('id','listdiv1');
        listItem.innerHTML = '<a data-index="' + i + '" onClick=viewDetails('+i+',"'+startDateString+'","'+endDateString+'","'+nombre+'","'+descripcion+'","'+horario+'","'+precio+'","'+infoExtra+'","'+coordenadasX+'","'+coordenadasY+'") > <h2>'+theItem.nombre.toString()+'</h2><p><strong>'+location+'</strong></p><a data-role="button" data-mini="true" href="#" onClick=calendarCall("'+startDateString+'","'+endDateString+'","'+nombre+'","'+location+'") data-icon="plus">Añadir a calendario</a></a>';
		parent.appendChild(listItem);
		 
	 });
  var list = document.getElementById('listview');
  $(list).listview("refresh");
  var  $toPage = $('#eventos');
    $.mobile.changePage($toPage);
  },
  error: function(msg) {
    alert("FAILED : " + msg.status + ' ' + msg.statusText);
  }
});
}

function getTiposItinerarios(){
	$.ajax({
	type: "GET",
	contentType: "application/json; charset=utf-8",
	dataType: "json",
	/*url:"http://192.168.1.130:8080/WSTurismoDigital/rest/turismoDigital/getTipoItinerarios?idioma=es",*/
	url:"http://85.251.45.123:65234/GISWeb/rest/itinerarios/getTipoItinerarios?idioma=es",
	data: '{}',
	success: function(msg) {	
		$.each(msg, function (i, theItem) {
			$('#tiposItinerariosSelect').append('<option value='+parseInt(theItem.id)+'>'+theItem.nombre.toString()	+'</option>');
	});
	$('#tiposItinerariosSelect').listview("refresh");
  	},
  	error: function(msg) {
    	alert("FAILED : " + msg.status + ' ' + msg.statusText);
  }
});
}

function getItinerarios(){
tipoEvento=$("#tiposItinerariosSelect").val();
$.ajax({
type: "GET",
contentType: "application/json; charset=utf-8",
dataType: "json",
  /*url: "http://192.168.1.130:8080/WSTurismoDigital/rest/turismoDigital/getItinerariosPorTipo?tipo=2592&idioma=es",*/
  url: "http://85.251.45.123:65234/GISWeb/rest/itinerarios/getItinerariosPorTipo?tipo="+tipoEvento+"&idioma=es",
  data: '{}',
  success: function(msg) {	
  var listview;
  var parent = document.getElementById('listviewItinerarios');	
  $('#listviewItinerarios').empty();
	$.each(msg, function (i, theItem) {
        var nombre = encodeURIComponent(theItem.nombre.toString());
		var descripcion = encodeURIComponent(theItem.descripcion.toString());
		
        var listdiv = document.createElement('li');
        listdiv.setAttribute('id','listdivIt');
        listdiv.setAttribute('data-role','list-divider');
        listdiv.innerHTML = theItem.nombre.toString();	
		parent.appendChild(listdiv);
		var listItem = document.createElement('li');
		listItem.setAttribute('id','listdivIt2');
        listItem.innerHTML = '<a data-index="' + i + '" onClick=viewDetailsItinerario('+theItem.id.toString()+',"'+nombre+'","'+descripcion+'") > <p style="white-space:normal;"><strong>'+decodeURIComponent(descripcion)+'</strong></p></a>';
		parent.appendChild(listItem);
	 });

  var list = document.getElementById('listviewItinerarios');
  $(list).listview("refresh");
  var  $toPage = $('#itinerarios');
    $.mobile.changePage($toPage);
  },
  error: function(msg) {
    alert("FAILED : " + msg.status + ' ' + msg.statusText);
  }
});
}

function getTiposGuias(){
	$.ajax({
	type: "GET",
	contentType: "application/json; charset=utf-8",
	dataType: "json",
	/*url:"http://192.168.1.130:8080/WSTurismoDigital/rest/turismoDigital/getTipoItinerarios?idioma=es",*/
	url:"http://85.251.45.123:65234/GISWeb/rest/guias/getTipoGuias?idioma=es",
	data: '{}',
	success: function(msg) {	
		$.each(msg, function (i, theItem) {
			$('#tiposGuiasSelect').append('<option value='+parseInt(theItem.id)+'>'+theItem.nombre.toString()	+'</option>');
	});
	$('#tiposGuiasSelect').listview("refresh");
  	},
  	error: function(msg) {
    	alert("FAILED : " + msg.status + ' ' + msg.statusText);
  }
});
}

function getGuias(){
tipoGuia=$("#tiposGuiasSelect").val();
$.ajax({
type: "GET",
contentType: "application/json; charset=utf-8",
dataType: "json",
  /*url: "http://192.168.1.130:8080/WSTurismoDigital/rest/turismoDigital/getItinerariosPorTipo?tipo=2592&idioma=es",*/
  url: "http://85.251.45.123:65234/GISWeb/rest/guias/getGuiasPorTipo?idioma=es&tipo="+tipoGuia,
  data: '{}',
  success: function(msg) {	
  var listview;
  var parent = document.getElementById('listviewGuias');	
  $('#listviewGuias').empty();
	$.each(msg, function (i, theItem) {
        var nombre = encodeURIComponent(theItem.nombre.toString());
		var descripcion = encodeURIComponent(theItem.descripcion.toString());
		
        var listdiv = document.createElement('li');
        listdiv.setAttribute('id','listdivGuia');
        listdiv.setAttribute('data-role','list-divider');
        listdiv.innerHTML = theItem.nombre.toString();	
		parent.appendChild(listdiv);
		var listItem = document.createElement('li');
		listItem.setAttribute('id','listdivGuia2');
        listItem.innerHTML = '<a data-index="' + i + '" onClick=viewDetailsGuia('+theItem.id.toString()+',"'+nombre+'","'+descripcion+'") > <p style="white-space:normal;"><strong>'+decodeURIComponent(descripcion)+'</strong></p></a>';
		parent.appendChild(listItem);
	 });

  var list = document.getElementById('listviewGuias');
  $(list).listview("refresh");
  var  $toPage = $('#guias');
    $.mobile.changePage($toPage);
  },
  error: function(msg) {
    alert("FAILED : " + msg.status + ' ' + msg.statusText);
  }
});
}

function calendarCall(start,end,title,location){
	var notes="";
	var dateParts = start.split("/");
    var startDate = new Date(dateParts[2], (dateParts[1] - 1), dateParts[0]);
    dateParts = end.split("/");
    var endDate = new Date(dateParts[2], (dateParts[1] - 1), dateParts[0]);   
    var titleString=decodeURIComponent(title);
    
	var success = function() { alert("Evento a�adido correctamente"); };
	var error = function(message) { alert("Error:No se ha a�adido el evento"); };
	window.plugins.calendarPlugin.createEvent(titleString,location,notes,startDate,endDate, success, error);
}

function viewDetails(index,fechaInicio,fechaFin,titulo,descripcion,horario,precio,infoExtra,coordenadasX,coordenadasY){
	    var  $toPage = $('#details_' + index);
    event.preventDefault();
    if ($toPage.length === 0) {
        $('body').append('<div data-role="page" id="details_' + index + '"><div data-role="content"><ul data-role="listview" data-inset="true"><li data-role="list-divider">' + fechaInicio + '&nbsp;al &nbsp;'+ fechaFin +'</li><li><h2>' + decodeURIComponent(titulo) + '</h2><p style="white-space:normal;"><strong>' + decodeURIComponent(descripcion) + '</strong><br><br></p><p>Horario: ' + decodeURIComponent(horario) + '</p><p class="ui-li-aside"><strong> Precio: ' + decodeURIComponent(precio) + '</strong></p><p>' + decodeURIComponent(infoExtra) + '<br><br></p><p align="center"><img src="http://maps.googleapis.com/maps/api/staticmap?center=' + coordenadasY + ',' + coordenadasX + '&zoom=15&size=300x300&markers=color:red%7Clabel:A%7C' + coordenadasY + ',' + coordenadasX +'&maptype=roadmap18&sensor=false"></p><p><a data-role="button" href="#eventos">Volver</a></p></li></ul></div></div>');
        
        //set the $toPage variable to the newly added page so jQuery Mobile can navigate to it
        $toPage = $('#details_' + index);
    }
    
    //change to the desired page
    $.mobile.changePage($toPage);
}

function viewDetailsItinerario(index,titulo,descripcion){
	var  $toPage = $('#detailsIt_' + index);
	var url="http://85.251.45.123:65234/GISWeb/rest/itinerarios/getItinerarioPuntosInteres?id="+index+"&idioma=es";
	
    event.preventDefault();
    if ($toPage.length === 0) {
        $('body').append('<div data-role="page" id="map-canvas" style="float:left;width:150;height:150;white-space:normal;"></div><b>' + decodeURIComponent(titulo) + '</b>');
        $toPage = $('#map-canvas');
		initialize(url);
    }
    $.mobile.changePage($toPage);
}

function viewDetailsGuia(index,titulo,descripcion){
	var  $toPage = $('#detailsGuia_' + index);
		var url="http://85.251.45.123:65234/GISWeb/rest/guias/getGuiaPuntosInteres?idioma=es&id="+index;
    event.preventDefault();
    if ($toPage.length === 0) {
        $('body').append('<div data-role="page" id="map-canvas" style="float:left;width:150;height:150;;white-space:normal;""></div><b>' + decodeURIComponent(titulo) + '</b>');
        $toPage = $('#map-canvas');
		initialize(url);
    }
    $.mobile.changePage($toPage);
}

var directionsDisplay;
var directionsService = new google.maps.DirectionsService();
var map;

function initialize(url) {
  directionsDisplay = new google.maps.DirectionsRenderer();
  var zgz = new google.maps.LatLng(41.65509037537398, -0.8801132440567017);
  var mapOptions = {
    zoom: 10,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    center: zgz
  }
  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  directionsDisplay.setMap(map);
  
  calcRoute(url);
}

function calcRoute(url) {
 var origin = null;
  var destination = null;
  var waypts = [];
	$.ajax({
		type: "GET",
		contentType: "application/json; charset=utf-8",
		dataType: "json",
		/*url:"http://192.168.1.130:8080/WSTurismoDigital/rest/turismoDigital/getItinerarioPuntosInteres?idioma=es",*/
		url:url,
		data: '{}',
		success: function(msg) {	
			$.each(msg, function (i, theItem) {
				if(i==0){
					//Si es el primer punto es el punto de origen
					origin=new google.maps.LatLng(theItem.coordenadaY.toString(), theItem.coordenadaX.toString());
				}else if(i==msg.length-1){
					//Si es el ultimo punto es el punto de destino
					destination=new google.maps.LatLng(theItem.coordenadaY.toString(), theItem.coordenadaX.toString());
				}else{
				 // Insertamos el punto
				 waypts.push({location: new google.maps.LatLng(theItem.coordenadaY.toString(), theItem.coordenadaX.toString()),
                        stopover:true
                    });
				}
			}
			);
		  //Creamos el mapa con los puntos
		  var request = {
      		origin: origin,
      		destination: destination,
      		waypoints: waypts,
      		optimizeWaypoints: true,
      		travelMode: google.maps.TravelMode.WALKING
  		  };
		  //Pintamos la ruta
  		 directionsService.route(request, function(response, status) {
    		if (status == google.maps.DirectionsStatus.OK) {
      			directionsDisplay.setDirections(response);
      			var route = response.routes[0];
    		}
  		 });
		},
		error: function(msg) {
			alert("ERROR : " + msg.status + ' ' + msg.statusText);
	  }
	});
}


</script>
</html>